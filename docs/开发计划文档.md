# 群辉NAS迅雷客户端开发计划

## 1. 项目准备阶段

### 1.1 开发环境搭建

#### 1.1.1 基础开发工具安装
- 安装 Node.js (v16.0.0+)
- 安装 npm 或 yarn 包管理工具
- 安装 Git 版本控制工具
- 安装 Visual Studio Code 或其他代码编辑器

#### 1.1.2 Tauri 开发环境配置
- **Windows 环境配置**：
  - 安装 Microsoft Visual Studio C++ 构建工具
  - 安装 WebView2 组件
  - 安装 Rust 环境 (rustup)
  - 配置 Rust 工具链 (stable)

- **macOS 环境配置**：
  - 安装 Xcode 命令行工具 (`xcode-select --install`)
  - 安装 Rust 环境 (rustup)
  - 配置 Rust 工具链 (stable)

#### 1.1.3 项目初始化
- 使用 Tauri CLI 创建项目：
  ```bash
  npm create nas-xunlei-client@latest
  ```
- 选择 Vue 3 作为前端框架
- 配置项目基本信息
- 初始化 Git 仓库

### 1.2 项目结构设计

#### 1.2.1 前端项目结构
```
src/
├── assets/         # 静态资源
├── components/     # Vue组件
│   ├── Config/     # 配置相关组件
│   └── Main/       # 主界面组件
├── router/         # 路由配置
├── store/          # 状态管理
├── utils/          # 工具函数
│   ├── auth.js     # 认证相关
│   └── webview.js  # WebView交互
├── views/          # 页面视图
│   ├── ConfigView.vue  # 配置页面
│   └── MainView.vue    # 主界面
└── App.vue         # 根组件
```

#### 1.2.2 Rust 后端结构
```
src-tauri/
├── src/
│   ├── main.rs     # 主入口
│   ├── cmd/        # 命令模块
│   │   ├── config.rs  # 配置相关命令
│   │   └── fs.rs      # 文件系统相关命令
│   └── utils/      # 工具函数
├── Cargo.toml      # Rust依赖配置
└── tauri.conf.json # Tauri配置
```

## 2. 开发阶段

### 2.1 配置管理功能开发 (预计2天)

#### 2.1.1 配置存储模块

- 实现配置数据结构设计
- 使用 Tauri 安全存储 API 实现配置的保存和读取
- 实现配置加密存储功能，特别是用户凭证
- ✅ 修复配置文件保存路径问题，确保使用正确的应用标识符

#### 2.1.2 配置界面开发

- 创建配置表单组件
- 实现表单验证逻辑
- 实现 NAS 连接测试功能
  - ✅ 添加代理检测功能，在连接测试失败时检查系统是否使用了代理
  - ✅ 根据代理检测结果提供不同的错误提示信息
- 开发配置保存和取消功能

#### 2.1.3 初始配置检测

- 实现应用启动时的配置检测逻辑
- 开发 NAS 连接可访问性检查功能
- 实现配置缺失或连接失败时的重定向逻辑

#### 2.1.4 调试与错误处理

- ✅ 添加调试模式，通过配置文件中的 `debug` 字段控制
- ✅ 在调试模式下输出详细的连接过程和错误信息
- ✅ 改进错误处理，提供更具体的错误提示

### 2.2 WebView 与 NAS 交互功能开发 (预计3天)

#### 2.2.1 WebView 基础功能

- 配置 WebView 组件加载 NAS 地址
- 实现页面加载状态监听
- 开发页面导航控制功能（前进、后退、刷新）

#### 2.2.2 自动登录功能

- 实现登录页面检测逻辑
- 开发两步登录流程自动填充功能：
  - 用户名填充与提交
  - 密码填充与提交
- 实现登录状态监听与错误处理

#### 2.2.3 JavaScript 注入功能

- 开发 JavaScript 注入机制
- 实现 DOM 操作功能，用于自动填充表单
- 开发事件模拟功能，用于自动点击

### 2.3 迅雷应用增强功能开发 (预计4天)

#### 2.3.1 界面增强功能

- 开发自定义按钮注入功能
- 实现"打开下载目录"按钮
- 开发与系统文件管理器的交互功能

#### 2.3.2 下载链接处理功能

- 实现系统级 URL 协议处理器注册
  - Windows: 注册表配置
  - macOS: Info.plist 配置
- 开发客户端自动启动逻辑
- 开发新建任务自动填充功能

### 2.4 用户界面开发 (预计3天)

#### 2.4.1 主界面开发

- 实现 WebView 容器
- 开发顶部控制栏
- 实现状态指示器
- 开发错误提示组件

#### 2.4.2 配置界面开发

- 实现分组配置表单
- 开发表单验证逻辑
- 实现密码显示/隐藏功能
- 开发网络路径选择器

#### 2.4.3 UI 美化与交互优化

- 实现响应式布局
- 开发过渡动画
- 实现深色/浅色主题支持
- 优化加载状态显示

### 2.5 错误处理与安全功能开发 (预计2天)

#### 2.5.1 错误处理机制

- 实现网络错误处理
- 开发登录失败处理
- 实现重试机制
- 开发用户友好的错误提示

#### 2.5.2 安全功能

- 实现密码加密存储
- 开发 HTTPS 证书验证
- 实现安全日志记录（不含敏感信息）

## 3. 测试阶段

### 3.1 单元测试 (预计1天)

#### 3.1.1 前端单元测试

- 配置组件测试环境
- 编写配置表单测试
- 实现 WebView 交互测试

#### 3.1.2 Rust 后端测试

- 编写配置存储测试
- 实现文件系统操作测试
- 开发 URL 处理测试

### 3.2 集成测试 (预计2天)

#### 3.2.1 功能集成测试

- 测试配置流程
- 验证自动登录功能
- 测试下载链接处理
- 验证文件夹打开功能

#### 3.2.2 跨平台测试

- Windows 平台测试
- macOS 平台测试
- 验证平台特定功能

### 3.3 用户体验测试 (预计1天)

#### 3.3.1 易用性测试

- 测试首次使用流程
- 验证错误提示友好性
- 测试界面响应速度

#### 3.3.2 边缘情况测试

- NAS 不可访问情况
- 网络中断恢复情况
- 凭证过期情况

## 4. 打包与发布阶段

### 4.1 应用打包 (预计1天)

#### 4.1.1 Windows 打包

- 配置应用图标和元数据
- 实现 NSIS 安装程序配置
- 生成 Windows 安装包

#### 4.1.2 macOS 打包

- 配置应用图标和元数据
- 实现 DMG 打包配置
- 生成 macOS 安装包

### 4.2 发布准备 (预计1天)

#### 4.2.1 文档编写

- 编写用户手册
- 创建安装指南
- 编写常见问题解答

#### 4.2.2 发布渠道准备

- 配置 GitHub Releases
- 准备更新服务器
- 设置自动更新机制

## 5. 项目时间线

| 阶段 | 任务 | 预计时间 | 累计时间 |
|------|------|----------|----------|
| 准备 | 环境搭建 | 1天 | 1天 |
| 准备 | 项目结构设计 | 1天 | 2天 |
| 开发 | 配置管理功能 | 2天 | 4天 |
| 开发 | WebView与NAS交互 | 3天 | 7天 |
| 开发 | 迅雷应用增强功能 | 4天 | 11天 |
| 开发 | 用户界面开发 | 3天 | 14天 |
| 开发 | 错误处理与安全功能 | 2天 | 16天 |
| 测试 | 单元测试 | 1天 | 17天 |
| 测试 | 集成测试 | 2天 | 19天 |
| 测试 | 用户体验测试 | 1天 | 20天 |
| 发布 | 应用打包 | 1天 | 21天 |
| 发布 | 发布准备 | 1天 | 22天 |

## 6. 技术依赖清单

### 6.1 前端依赖

- Vue 3.0
- Vue Router
- Pinia (状态管理)
- Axios (HTTP请求)
- Vuelidate (表单验证)
- TailwindCSS (样式)

### 6.2 Tauri 依赖

- tauri-build
- tauri-plugin-store (配置存储)
- tauri-plugin-window-state (窗口状态保存)
- tauri-plugin-fs (文件系统操作)

### 6.3 Rust 依赖

- serde (序列化/反序列化)
- tokio (异步运行时)
- reqwest (HTTP客户端)
- keyring (凭证安全存储)
- url (URL解析)

## 7. 功能实现细节

### 7.1 自动登录实现细节

```javascript
// 登录状态检测
function detectLoginPage(url) {
  return url.includes('/webman/login.cgi');
}

// 自动填充用户名
async function autoFillUsername(username) {
  const usernameInput = document.querySelector('#username');
  if (usernameInput) {
    usernameInput.value = username;
    const submitButton = document.querySelector('#btn-login');
    if (submitButton) {
      submitButton.click();
    }
  }
}

// 自动填充密码
async function autoFillPassword(password) {
  const passwordInput = document.querySelector('#password');
  if (passwordInput) {
    passwordInput.value = password;
    const submitButton = document.querySelector('#btn-login');
    if (submitButton) {
      submitButton.click();
    }
  }
}
```

### 7.2 打开下载目录实现细节

```rust
// Rust 后端实现
#[tauri::command]
fn open_download_directory(path: String) -> Result<(), String> {
  #[cfg(target_os = "windows")]
  {
    use std::process::Command;
    Command::new("explorer")
      .args([&path])
      .spawn()
      .map_err(|e| e.to_string())?;
  }

  #[cfg(target_os = "macos")]
  {
    use std::process::Command;
    Command::new("open")
      .args([&path])
      .spawn()
      .map_err(|e| e.to_string())?;
  }

  Ok(())
}
```

### 7.3 下载链接处理实现细节

```rust
// 注册URL协议处理器
fn register_protocol_handler() {
  #[cfg(target_os = "windows")]
  {
    // Windows注册表操作
    // 注册thunder://和magnet:协议
  }

  #[cfg(target_os = "macos")]
  {
    // macOS Info.plist配置已在打包时完成
  }
}

// 处理下载链接
#[tauri::command]
fn handle_download_link(url: String) -> Result<(), String> {
  // 解析链接
  // 启动应用（如果未运行）
  // 注入JS脚本模拟点击"新建任务"
  // 填充下载链接
  Ok(())
}
```

## 8. 项目风险与应对策略

### 8.1 技术风险

| 风险 | 可能性 | 影响 | 应对策略 |
|------|--------|------|----------|
| NAS界面变更导致自动化失效 | 中 | 高 | 设计更灵活的DOM选择器，增加多种选择策略 |
| 不同版本群辉系统兼容性问题 | 高 | 中 | 测试多个DSM版本，提供版本检测和兼容模式 |
| WebView注入JavaScript安全限制 | 中 | 高 | 研究CSP绕过方案，或使用WebView预加载脚本 |

### 8.2 项目风险

| 风险 | 可能性 | 影响 | 应对策略 |
|------|--------|------|----------|
| 开发时间超出预期 | 中 | 中 | 优先实现核心功能，其他功能迭代开发 |
| 用户体验不符合预期 | 低 | 高 | 早期进行原型测试，收集用户反馈 |
| 跨平台兼容性问题 | 中 | 中 | 设计时考虑平台差异，增加平台特定代码 |

## 9. 未来迭代计划

### 9.1 第二阶段功能

- 下载任务管理增强
  - 批量添加下载任务
  - 任务优先级调整
  - 下载完成通知

### 9.2 第三阶段功能

- 下载速度图表显示
- 移动端远程控制功能
- 多NAS设备管理

## 10. 总结

本开发计划详细描述了群辉NAS迅雷客户端从零开始的完整开发流程，包括环境搭建、功能开发、测试和发布各个阶段。总体开发周期预计为22个工作日，涵盖了产品设计文档中的所有功能需求。通过遵循本计划，可以有序地完成应用开发，并确保最终产品满足用户需求。
